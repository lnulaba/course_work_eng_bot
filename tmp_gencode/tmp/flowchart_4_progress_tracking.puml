@startuml flowchart_4_progress_tracking
!theme plain
skinparam backgroundColor White
skinparam activity {
    BackgroundColor LightSalmon
    BorderColor DarkRed
    FontColor Black
    FontSize 11
}
skinparam decision {
    BackgroundColor LightYellow
    BorderColor Orange
}
skinparam activityStart {
    Color Green
}
skinparam activityEnd {
    Color Red
}

title **–ë–ª–æ–∫-—Å—Ö–µ–º–∞ 4: –ê–ª–≥–æ—Ä–∏—Ç–º –≤—ñ–¥—Å—Ç–µ–∂–µ–Ω–Ω—è –ø—Ä–æ–≥—Ä–µ—Å—É**

start

:üìä –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á –æ–±–∏—Ä–∞—î "–ú–æ—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞";

:üë§ –û—Ç—Ä–∏–º–∞—Ç–∏ ID –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞;
note right: user_id –∑ —Ç–µ–ª–µ–≥—Ä–∞–º —Å–µ—Å—ñ—ó

:üìà **–ó–ê–í–ê–ù–¢–ê–ñ–ï–ù–ù–Ø –û–°–ù–û–í–ù–û–á –°–¢–ê–¢–ò–°–¢–ò–ö–ò**;

:üìã –û—Ç—Ä–∏–º–∞—Ç–∏ –ø–æ—Ç–æ—á–Ω–∏–π –ø—Ä–æ–≥—Ä–µ—Å;
note right
    SELECT up.*, u.username, u.created_at
    FROM user_progress up
    JOIN users u ON up.user_id = u.user_id  
    WHERE up.user_id = ?
end note

:üéØ –û—Ç—Ä–∏–º–∞—Ç–∏ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è;
note right
    SELECT daily_goal, preferred_language
    FROM settings 
    WHERE user_id = ?
end note

:üìö **–†–û–ó–†–ê–•–£–ù–û–ö –î–ï–¢–ê–õ–¨–ù–û–á –°–¢–ê–¢–ò–°–¢–ò–ö–ò**;

:üî¢ –ü—ñ–¥—Ä–∞—Ö—É–≤–∞—Ç–∏ –∑–∞–≥–∞–ª—å–Ω—ñ —Å–µ—Å—ñ—ó;
note right
    SELECT 
        COUNT(*) as total_sessions,
        COUNT(CASE WHEN is_completed = TRUE THEN 1 END) as completed_sessions,
        AVG(CASE WHEN is_completed = TRUE THEN 
            (correct_answers/questions_answered)*100 END) as avg_accuracy
    FROM test_sessions 
    WHERE user_id = ?
end note

:üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Ç–∏–ø–∞—Ö —Å–µ—Å—ñ–π;
note right
    SELECT 
        session_type,
        COUNT(*) as count,
        AVG((correct_answers/questions_answered)*100) as avg_accuracy,
        SUM(questions_answered) as total_questions,
        SUM(correct_answers) as total_correct
    FROM test_sessions 
    WHERE user_id = ? AND is_completed = TRUE
    GROUP BY session_type
end note

:üìÖ –ê–∫—Ç–∏–≤–Ω—ñ—Å—Ç—å –∑–∞ –æ—Å—Ç–∞–Ω–Ω—ñ 7 –¥–Ω—ñ–≤;
note right
    SELECT 
        DATE(started_at) as session_date,
        COUNT(*) as sessions_count,
        SUM(questions_answered) as questions_count,
        AVG((correct_answers/questions_answered)*100) as daily_accuracy
    FROM test_sessions 
    WHERE user_id = ? 
        AND started_at >= DATE_SUB(NOW(), INTERVAL 7 DAY)
        AND is_completed = TRUE
    GROUP BY DATE(started_at)
    ORDER BY session_date DESC
end note

:üèÜ **–ê–ù–ê–õ–Ü–ó –î–û–°–Ø–ì–ù–ï–ù–¨**;

:üéØ –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —â–æ–¥–µ–Ω–Ω–æ—ó —Ü—ñ–ª—ñ;
note right
    today_questions = SELECT SUM(questions_answered)
    FROM test_sessions 
    WHERE user_id = ? 
        AND DATE(started_at) = CURDATE()
        AND is_completed = TRUE
        
    goal_progress = (today_questions / daily_goal) * 100
end note

:üìà –ü—Ä–æ–≥—Ä–µ—Å –∑–∞ –º—ñ—Å—è—Ü—å;
note right
    SELECT 
        WEEK(started_at) as week_num,
        COUNT(*) as weekly_sessions,
        AVG((correct_answers/questions_answered)*100) as weekly_accuracy,
        SUM(questions_answered) as weekly_questions
    FROM test_sessions 
    WHERE user_id = ? 
        AND started_at >= DATE_SUB(NOW(), INTERVAL 30 DAY)
        AND is_completed = TRUE
    GROUP BY WEEK(started_at)
    ORDER BY week_num DESC
end note

:üèÖ –í–∏–∑–Ω–∞—á–µ–Ω–Ω—è –¥–æ—Å—è–≥–Ω–µ–Ω—å;
note right
    achievements = []
    
    // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Ä—ñ–∑–Ω–∏—Ö –¥–æ—Å—è–≥–Ω–µ–Ω—å
    if total_sessions >= 10: achievements.add("–ê–∫—Ç–∏–≤–Ω–∏–π —É—á–µ–Ω—å")
    if avg_accuracy >= 90: achievements.add("–ï–∫—Å–ø–µ—Ä—Ç")
    if streak_days >= 7: achievements.add("–¢–∏–∂–Ω–µ–≤–∏–π –≤–æ—ó–Ω")
    if total_questions >= 1000: achievements.add("–¢–∏—Å—è—á–∞ –ø–∏—Ç–∞–Ω—å")
    
    // –î–æ—Å—è–≥–Ω–µ–Ω–Ω—è –∑–∞ —Ä—ñ–≤–Ω–µ–º
    if level_english >= "B2": achievements.add("–ü—Ä–æ—Å—É–Ω—É—Ç–∏–π —Ä—ñ–≤–µ–Ω—å")
end note

:üìä **–§–û–†–ú–£–í–ê–ù–ù–Ø –ó–í–Ü–¢–£**;

:üì± –°—Ç–≤–æ—Ä–∏—Ç–∏ –æ—Å–Ω–æ–≤–Ω–∏–π –∑–≤—ñ—Ç;
note right
    main_report = f"""
    üìä **–¢–í–û–Ø –°–¢–ê–¢–ò–°–¢–ò–ö–ê**
    
    üë§ –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á: {username}
    üéØ –ü–æ—Ç–æ—á–Ω–∏–π —Ä—ñ–≤–µ–Ω—å: {level_english}
    üìÖ –ó –Ω–∞–º–∏ –∑: {created_at.strftime('%d.%m.%Y')}
    
    üìà **–ó–ê–ì–ê–õ–¨–ù–Ü –ü–û–ö–ê–ó–ù–ò–ö–ò:**
    ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–∏—Ö –≤—ñ–¥–ø–æ–≤—ñ–¥–µ–π: {correct_answers}/{total_questions_answered}
    üìä –ó–∞–≥–∞–ª—å–Ω–∞ —Ç–æ—á–Ω—ñ—Å—Ç—å: {accuracy:.1f}%
    üéØ –ü—Ä–æ–π–¥–µ–Ω–æ —Å–µ—Å—ñ–π: {completed_sessions}/{total_sessions}
    
    üìÖ **–°–¨–û–ì–û–î–ù–Ü:**
    üìö –ü–∏—Ç–∞–Ω—å –≤—ñ–¥–ø–æ–≤—ñ–ª–∏: {today_questions}
    üéØ –ü—Ä–æ–≥—Ä–µ—Å –¥–æ —Ü—ñ–ª—ñ: {goal_progress:.0f}% ({today_questions}/{daily_goal})
    """
end note

:üìà –î–æ–¥–∞—Ç–∏ –¥–µ—Ç–∞–ª—ñ –ø–æ —Ç–∏–ø–∞—Ö;
note right
    for session_type, stats in session_type_stats:
        report += f"""
        
        üìö **{session_type.upper()}:**
        ‚Ä¢ –°–µ—Å—ñ–π: {stats.count}
        ‚Ä¢ –¢–æ—á–Ω—ñ—Å—Ç—å: {stats.avg_accuracy:.1f}%
        ‚Ä¢ –ü–∏—Ç–∞–Ω—å: {stats.total_questions}
        """
end note

:üìÖ –î–æ–¥–∞—Ç–∏ –∞–∫—Ç–∏–≤–Ω—ñ—Å—Ç—å –∑–∞ —Ç–∏–∂–¥–µ–Ω—å;
note right
    report += f"""
    
    üìÖ **–ê–ö–¢–ò–í–ù–Ü–°–¢–¨ –ó–ê 7 –î–ù–Ü–í:**
    """
    
    for day_stat in weekly_activity:
        report += f"""
        üìÜ {day_stat.date}: {day_stat.sessions_count} —Å–µ—Å—ñ–π, 
           {day_stat.questions_count} –ø–∏—Ç–∞–Ω—å ({day_stat.accuracy:.0f}%)
        """
end note

if (üèÜ –Ñ –¥–æ—Å—è–≥–Ω–µ–Ω–Ω—è?) then (‚úÖ –¢–ê–ö)
    :üèÖ –î–æ–¥–∞—Ç–∏ –¥–æ—Å—è–≥–Ω–µ–Ω–Ω—è –¥–æ –∑–≤—ñ—Ç—É;
    note right
        report += f"""
        
        üèÜ **–¢–í–û–á –î–û–°–Ø–ì–ù–ï–ù–ù–Ø:**
        """
        
        for achievement in achievements:
            report += f"üèÖ {achievement}\n"
    end note
endif

:üìä **–ê–ù–ê–õ–Ü–ó –¢–ï–ù–î–ï–ù–¶–Ü–ô**;

:üìà –ü–æ—Ä—ñ–≤–Ω—è–Ω–Ω—è –∑ –º–∏–Ω—É–ª–∏–º —Ç–∏–∂–Ω–µ–º;
note right
    last_week_stats = SELECT AVG(accuracy) 
    FROM weekly_stats 
    WHERE week_start = DATE_SUB(CURDATE(), INTERVAL 7 DAY)
    
    current_week_stats = SELECT AVG(accuracy)
    FROM weekly_stats 
    WHERE week_start = CURDATE()
    
    trend = current_week_stats - last_week_stats
end note

if (üìà –ü–æ–∑–∏—Ç–∏–≤–Ω–∞ —Ç–µ–Ω–¥–µ–Ω—Ü—ñ—è?) then (trend > 0)
    :üìà "–¢–≤–æ—ó —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∏ –ø–æ–∫—Ä–∞—â—É—é—Ç—å—Å—è!";
    :üí™ –ú–æ—Ç–∏–≤–∞—Ü—ñ–π–Ω–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è;
    note right
        "üéâ –í—ñ–¥–º—ñ–Ω–Ω–æ! –¢–≤–æ—è —Ç–æ—á–Ω—ñ—Å—Ç—å –∑—Ä–æ—Å–ª–∞ –Ω–∞ {trend:.1f}%!
        –ü—Ä–æ–¥–æ–≤–∂—É–π –≤ —Ç–æ–º—É –∂ –¥—É—Å—ñ! üí™"
    end note
    
elseif (üìâ –ù–µ–≥–∞—Ç–∏–≤–Ω–∞ —Ç–µ–Ω–¥–µ–Ω—Ü—ñ—è?) then (trend < -5)
    :üìâ "–ü–æ—Ç—Ä—ñ–±–Ω–æ –±—ñ–ª—å—à–µ –ø—Ä–∞–∫—Ç–∏–∫–∏";
    :üí° –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—ó –¥–ª—è –ø–æ–∫—Ä–∞—â–µ–Ω–Ω—è;
    note right
        "üìö –†–µ–∫–æ–º–µ–Ω–¥—É—é:
        ‚Ä¢ –ü–æ–≤—Ç–æ—Ä–∏—Ç–∏ —Å–∫–ª–∞–¥–Ω—ñ —Ç–µ–º–∏
        ‚Ä¢ –ü—Ä–æ–π—Ç–∏ –¥–æ–¥–∞—Ç–∫–æ–≤—ñ —Ç–µ—Å—Ç–∏
        ‚Ä¢ –í–∏–≤—á–∏—Ç–∏ –Ω–æ–≤—ñ —Å–ª–æ–≤–∞
        
        üí™ –ù–µ –∑–¥–∞–≤–∞–π—Å—è! –í—Å–µ –≤–∏–π–¥–µ!"
    end note
    
else (üìä –°—Ç–∞–±—ñ–ª—å–Ω—ñ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∏)
    :‚öñÔ∏è "–°—Ç–∞–±—ñ–ª—å–Ω—ñ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∏";
    :üéØ –ü—Ä–æ–ø–æ–∑–∏—Ü—ñ—è –Ω–æ–≤–∏—Ö –≤–∏–∫–ª–∏–∫—ñ–≤;
    note right
        "üéØ –°—Ç–∞–±—ñ–ª—å–Ω—ñ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∏ - —Ü–µ –¥–æ–±—Ä–µ!
        –ú–æ–∂–ª–∏–≤–æ, —á–∞—Å –¥–ª—è –Ω–æ–≤–æ–≥–æ –≤–∏–∫–ª–∏–∫—É?
        
        ‚Ä¢ –°–ø—Ä–æ–±—É–≤–∞—Ç–∏ —Å–∫–ª–∞–¥–Ω—ñ—à—ñ —Ç–µ—Å—Ç–∏
        ‚Ä¢ –ü–µ—Ä–µ–π—Ç–∏ –Ω–∞ –Ω–æ–≤–∏–π —Ä—ñ–≤–µ–Ω—å
        ‚Ä¢ –í–∏–≤—á–∏—Ç–∏ –Ω–æ–≤—É —Ç–µ–º—É"
    end note
endif

:üéØ **–†–ï–ö–û–ú–ï–ù–î–ê–¶–Ü–á**;

:üîÆ –ê–Ω–∞–ª—ñ–∑ —Å–ª–∞–±–∫–∏—Ö –º—ñ—Å—Ü—å;
note right
    weak_topics = SELECT t.topic_name, AVG(accuracy) as avg_score
    FROM test_sessions ts
    JOIN questions q ON ts.session_id = q.session_id  
    JOIN topics t ON q.topic_id = t.topic_id
    WHERE ts.user_id = ? AND ts.is_completed = TRUE
    GROUP BY t.topic_id
    HAVING avg_score < 70
    ORDER BY avg_score ASC
    LIMIT 3
end note

if (üìö –Ñ —Å–ª–∞–±–∫—ñ —Ç–µ–º–∏?) then (‚úÖ –¢–ê–ö)
    :üí° –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—ó –¥–ª—è –ø–æ–∫—Ä–∞—â–µ–Ω–Ω—è;
    note right
        recommendations += f"""
        
        üí° **–†–ï–ö–û–ú–ï–ù–î–ê–¶–Ü–á:**
        
        üìö –í–∞—Ä—Ç–æ –ø–æ–≤—Ç–æ—Ä–∏—Ç–∏:
        """
        
        for topic in weak_topics:
            recommendations += f"‚Ä¢ {topic.name} (—Ç–æ—á–Ω—ñ—Å—Ç—å: {topic.avg_score:.0f}%)\n"
            
        recommendations += """
        
        üéØ –ü—Ä–æ–π–¥–∏ –¥–æ–¥–∞—Ç–∫–æ–≤—ñ —Ç–µ—Å—Ç–∏ –∑ —Ü–∏—Ö —Ç–µ–º
        üìñ –í–∏–≤—á–∏ –Ω–æ–≤—ñ —Å–ª–æ–≤–∞ –∑–∞ —Ü–∏–º–∏ —Ç–µ–º–∞–º–∏
        """
    end note
endif

:üéÆ –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç—ñ –¥–æ –ø—ñ–¥–≤–∏—â–µ–Ω–Ω—è;
note right
    if accuracy >= 80 AND total_questions_answered >= 100:
        next_level = get_next_level(current_level)
        level_up_ready = True
    else:
        level_up_ready = False
end note

if (‚¨ÜÔ∏è –ì–æ—Ç–æ–≤–∏–π –¥–æ –ø—ñ–¥–≤–∏—â–µ–Ω–Ω—è?) then (‚úÖ –¢–ê–ö)
    :üéì –ó–∞–ø—Ä–æ–ø–æ–Ω—É–≤–∞—Ç–∏ —Ç–µ—Å—Ç –Ω–∞ –ø—ñ–¥–≤–∏—â–µ–Ω–Ω—è;
    note right
        "üéì **–í–Ü–¢–ê–Æ!**
        
        –¢–≤–æ—ó —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∏ –ø–æ–∫–∞–∑—É—é—Ç—å, —â–æ —Ç–∏ –≥–æ—Ç–æ–≤–∏–π
        –¥–æ –ø–µ—Ä–µ—Ö–æ–¥—É –Ω–∞ —Ä—ñ–≤–µ–Ω—å {next_level}!
        
        üéØ –¢–æ—á–Ω—ñ—Å—Ç—å: {accuracy:.1f}% (–ø–æ—Ç—Ä—ñ–±–Ω–æ ‚â•80%)
        üìö –ü–∏—Ç–∞–Ω—å –ø—Ä–æ–π–¥–µ–Ω–æ: {total_questions_answered} (–ø–æ—Ç—Ä—ñ–±–Ω–æ ‚â•100)
        
        –•–æ—á–µ—à –ø—Ä–æ–π—Ç–∏ —Ç–µ—Å—Ç –Ω–∞ –ø—ñ–¥–≤–∏—â–µ–Ω–Ω—è —Ä—ñ–≤–Ω—è?"
    end note
    
    if (üéØ –ü—Ä–æ–π—Ç–∏ —Ç–µ—Å—Ç?) then (‚úÖ –¢–ê–ö)
        :üöÄ –ó–∞–ø—É—Å—Ç–∏—Ç–∏ —Ç–µ—Å—Ç –Ω–∞ –ø—ñ–¥–≤–∏—â–µ–Ω–Ω—è;
        note right: –ü–µ—Ä–µ—Ö—ñ–¥ –¥–æ –∞–ª–≥–æ—Ä–∏—Ç–º—É —Ç–µ—Å—Ç—É–≤–∞–Ω–Ω—è –≤–∏—â–æ–≥–æ —Ä—ñ–≤–Ω—è
    endif
endif

:üì± **–í–Ü–î–û–ë–†–ê–ñ–ï–ù–ù–Ø –†–ï–ó–£–õ–¨–¢–ê–¢–Ü–í**;

:üìä –ü–æ–∫–∞–∑–∞—Ç–∏ –ø–æ–≤–Ω–∏–π –∑–≤—ñ—Ç;
note right
    –í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—É:
    ‚Ä¢ –û—Å–Ω–æ–≤–Ω–∏–π –∑–≤—ñ—Ç
    ‚Ä¢ –î–µ—Ç–∞–ª—ñ –ø–æ —Ç–∏–ø–∞—Ö –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—ñ  
    ‚Ä¢ –î–æ—Å—è–≥–Ω–µ–Ω–Ω—è
    ‚Ä¢ –¢–µ–Ω–¥–µ–Ω—Ü—ñ—ó
    ‚Ä¢ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—ó
    ‚Ä¢ –ú–æ–∂–ª–∏–≤–æ—Å—Ç—ñ –ø—ñ–¥–≤–∏—â–µ–Ω–Ω—è
end note

:üíæ –û–Ω–æ–≤–∏—Ç–∏ —á–∞—Å –æ—Å—Ç–∞–Ω–Ω—å–æ–≥–æ –ø–µ—Ä–µ–≥–ª—è–¥—É;
note right
    UPDATE user_progress 
    SET last_stats_viewed = NOW() 
    WHERE user_id = ?
end note

:üè† –ü–æ–≤–µ—Ä–Ω—É—Ç–∏—Å—è –¥–æ –≥–æ–ª–æ–≤–Ω–æ–≥–æ –º–µ–Ω—é;

stop

@enduml
